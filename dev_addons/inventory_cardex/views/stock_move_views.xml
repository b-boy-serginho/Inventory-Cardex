<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Extender la vista de árbol (list) de stock.move para agregar el campo Costo -->
    <record id="view_stock_move_tree_inherit_cardex" model="ir.ui.view">
        <field name="name">stock.move.tree.inherit.cardex</field>
        <field name="model">stock.move</field>
        <field name="inherit_id" ref="stock.view_move_tree"/>
        <field name="arch" type="xml">
            
            <!-- Agregar el campo Costo después de la columna Producto -->
            <xpath expr="//field[@name='product_id']" position="after">
                <field name="product_cost" string="Costo Unit." 
                       widget="monetary" 
                       options="{'currency_field': 'company_currency_id'}"/>
                <field name="total_cost" string="Costo Total" 
                       widget="monetary" 
                       options="{'currency_field': 'company_currency_id'}"
                       optional="hide"/>
                <field name="company_currency_id" invisible="1"/>
            </xpath>
            
        </field>
    </record>

    <!-- Extender TAMBIÉN la vista de reportes (stock.move.tree2) -->
    <record id="view_stock_move_tree2_inherit_cardex" model="ir.ui.view">
        <field name="name">stock.move.tree2.inherit.cardex</field>
        <field name="model">stock.move</field>
        <field name="inherit_id" ref="stock.view_move_tree_receipt_picking"/>
        <field name="arch" type="xml">
            
            <!-- Agregar el campo Costo después de la columna Producto -->
            <xpath expr="//field[@name='product_id']" position="after">
                <field name="product_cost" string="Costo" 
                       widget="monetary" 
                       options="{'currency_field': 'company_currency_id'}"
                       optional="show"/>
                <field name="total_cost" string="Costo Total" 
                       widget="monetary" 
                       options="{'currency_field': 'company_currency_id'}"
                       optional="hide"/>
                <field name="company_currency_id" invisible="1"/>
            </xpath>
            
        </field>
    </record>


    <!-- Extender la vista de picking moves -->
    <record id="view_stock_picking_move_tree_inherit_cardex" model="ir.ui.view">
        <field name="name">stock.picking.move.tree.inherit.cardex</field>
        <field name="model">stock.move</field>
        <field name="inherit_id" ref="stock.view_picking_move_tree"/>
        <field name="arch" type="xml">
            
            <!-- Agregar el campo Costo después de la columna Producto -->
            <xpath expr="//field[@name='product_id']" position="after">
                <field name="product_cost" string="Costo" 
                       widget="monetary" 
                       options="{'currency_field': 'company_currency_id'}"
                       optional="show"/>
                <field name="total_cost" string="Costo Total" 
                       widget="monetary" 
                       options="{'currency_field': 'company_currency_id'}"
                       optional="hide"/>
                <field name="company_currency_id" invisible="1"/>
            </xpath>
            
        </field>
    </record>

    <!-- Extender la vista de formulario de stock.move para mostrar información de costo -->
    <record id="view_stock_move_form_inherit_cardex" model="ir.ui.view">
        <field name="name">stock.move.form.inherit.cardex</field>
        <field name="model">stock.move</field>
        <field name="inherit_id" ref="stock.view_move_form"/>
        <field name="arch" type="xml">
            
            <!-- Agregar información de costo en el formulario -->
            <xpath expr="//field[@name='product_uom_qty']" position="after">
                <field name="product_cost" string="Costo Unitario" 
                       widget="monetary"
                       options="{'currency_field': 'company_currency_id'}"/>
                <field name="total_cost" string="Costo Total del Movimiento" 
                       widget="monetary"
                       options="{'currency_field': 'company_currency_id'}"/>
                <field name="company_currency_id" invisible="1"/>
            </xpath>
            
        </field>
    </record>


    <!-- Vista de búsqueda mejorada con filtro por costo -->
    <record id="view_stock_move_search_inherit_cardex" model="ir.ui.view">
        <field name="name">stock.move.search.inherit.cardex</field>
        <field name="model">stock.move</field>
        <field name="inherit_id" ref="stock.view_move_search"/>
        <field name="arch" type="xml">
            
            <!-- Agregar filtros de búsqueda por costo -->
            <xpath expr="//search" position="inside">
                <filter string="Costo Alto (&gt;100)" name="high_cost" 
                        domain="[('product_cost', '&gt;', 100)]"/>
                <filter string="Costo Medio (10-100)" name="medium_cost" 
                        domain="[('product_cost', '&gt;=', 10), ('product_cost', '&lt;=', 100)]"/>
                <filter string="Costo Bajo (&lt;10)" name="low_cost" 
                        domain="[('product_cost', '&lt;', 10)]"/>
                
                <group expand="0" string="Agrupar por">
                    <filter string="Rango de Costo" name="group_by_cost_range" 
                            context="{'group_by': 'product_cost'}"/>
                </group>
            </xpath>
            
        </field>
    </record>

    <!-- Vista de árbol NUEVA para stock.move.line con campos de costo -->
    <!-- Esta vista NO hereda de ninguna otra para evitar problemas con parent.show_quant -->
    <record id="view_stock_move_line_cardex_tree" model="ir.ui.view">
        <field name="name">stock.move.line.cardex.tree</field>
        <field name="model">stock.move.line</field>
        <field name="priority">10</field> <!-- Alta prioridad para usar esta vista -->
        <field name="arch" type="xml">
            <tree string="Movimientos Detallados (Cardex)" editable="bottom">
                <!-- Campos técnicos (ocultos por defecto pero disponibles para dominios) -->
                <field name="product_uom_category_id" optional="hide"/>
                <field name="company_id" optional="hide"/>
                <field name="company_currency_id" optional="hide"/>
                <field name="sale_currency_id" optional="hide"/>
                <field name="purchase_currency_id" optional="hide"/>

                <!-- ========== CAMPOS DE INVENTARIO ========== -->
                <field name="date" string="Fecha"/>
                <field name="reference" string="Referencia"/>

                 <!-- ========== CAMPOS DE COMPRA (purchase_order_line) ========== -->
                <field name="has_purchase" string="Tiene Compra" optional="hide"/>
                <field name="has_purchase_qty" optional="hide" invisible="1"/>
                <field name="purchase_order_id" string="Pedido Compra" optional="hide"/>
                <field name="purchase_product_name" string="Descripción Compra" optional="hide"/>
                <field name="purchase_product_qty" string="Cantidad Comprada" optional="hide"/>
                <field name="purchase_price_unit" string="Precio Unit. Compra" 
                       widget="monetary"
                       options="{'currency_field': 'purchase_currency_id'}"
                       optional="hide"/>
                <field name="purchase_price_subtotal" string="Subtotal Compra" 
                       widget="monetary"
                       options="{'currency_field': 'purchase_currency_id'}"
                       optional="hide"/>
                <field name="purchase_price_tax" string="Impuestos Compra" 
                       widget="monetary"
                       options="{'currency_field': 'purchase_currency_id'}"
                       optional="hide"/>
                <field name="purchase_price_total" string="Total Compra" 
                       widget="monetary"
                       options="{'currency_field': 'purchase_currency_id'}"
                       optional="hide"/>
                <field name="purchase_state" string="Estado Compra" 
                       optional="hide" 
                       readonly="1"/>

                 <!-- ========== CAMPOS DE VENTA (sale_order_line) ========== -->
                <field name="has_sale" string="Tiene Venta" optional="hide"/>
                <field name="has_sale_qty" optional="hide" invisible="1"/>
                <field name="sale_order_id" string="Pedido Venta" optional="hide"/>
                <field name="sale_product_name" string="Descripción Venta" optional="hide"/>
                <field name="sale_product_uom_qty" string="Cantidad Vendida" optional="hide"/>
                <field name="sale_price_unit" string="Precio Unit. Venta" 
                       widget="monetary"
                       options="{'currency_field': 'sale_currency_id'}"
                       optional="hide"/>
                <field name="sale_price_subtotal" string="Subtotal Venta" 
                       widget="monetary"
                       options="{'currency_field': 'sale_currency_id'}"
                       optional="hide"/>
                <field name="sale_price_tax" string="Impuestos Venta" 
                       widget="monetary"
                       options="{'currency_field': 'sale_currency_id'}"
                       optional="hide"/>
                <field name="sale_price_total" string="Total Venta" 
                       widget="monetary"
                       options="{'currency_field': 'sale_currency_id'}"
                       optional="hide"/>
                <field name="sale_state" string="Estado Venta" optional="hide"/>               
                            
                <!-- ========== CAMPOS DE INVENTARIO ========== -->
                <!-- Orden de campos según lo solicitado -->                              
                <field name="location_id" optional="hide"/>
                <field name="location_dest_id" optional="hide"/>
                <field name="product_id" string="Producto"/>
                <field name="quantity" string="Cantidad"/>
                <field name="product_cost" string="Costo Unitario" 
                       widget="monetary"
                       options="{'currency_field': 'company_currency_id'}"/>
                <field name="line_cost" string="Costo Total" 
                       widget="monetary"
                       options="{'currency_field': 'company_currency_id'}"/>
                <field name="state" string="Estado"/>                         
                
                <!-- ========== CAMPOS OPCIONALES DE INVENTARIO ========== -->
                <field name="product_uom_id" string="UdM" groups="uom.group_uom" optional="hide"/>
                <field name="incoming_qty" string="Qty Entrante" optional="hide"/>
                <field name="outgoing_qty" string="Qty Saliente" optional="hide"/>
                <field name="lot_id" optional="hide" groups="stock.group_production_lot"/>
                <field name="package_id" optional="hide" groups="stock.group_tracking_lot"/>
                <field name="result_package_id" optional="hide" groups="stock.group_tracking_lot"/>
                <field name="owner_id" optional="hide" groups="stock.group_tracking_owner"/>
                <field name="picking_id" optional="hide"/>
            </tree>
        </field>
    </record>

    <!-- Acción de ventana para abrir los movimientos detallados con costos -->
    <record id="action_stock_move_line_cardex" model="ir.actions.act_window">
        <field name="name">Movimientos Detallados (Cardex)</field>
        <field name="res_model">stock.move.line</field>
        <field name="view_mode">tree,form</field>
        <field name="view_id" ref="view_stock_move_line_cardex_tree"/>
        <field name="domain">[]</field>
        <field name="context">{}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No hay movimientos detallados de stock
            </p>
            <p>
                Aquí puedes ver todos los movimientos de stock a nivel detallado con información de costos.
            </p>
        </field>
    </record>

    <!-- Ítem de menú en Inventario > Reportes -->
    <menuitem 
        id="menu_stock_move_line_cardex"
        name="Movimientos Detallados (Cardex)"
        parent="stock.menu_warehouse_report"
        action="action_stock_move_line_cardex"
        sequence="100"/>

</odoo>
