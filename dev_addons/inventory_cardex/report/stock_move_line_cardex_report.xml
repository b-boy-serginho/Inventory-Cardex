<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Definición del reporte PDF -->
    <record id="action_report_stock_move_line_cardex" model="ir.actions.report">
        <field name="name">Reporte Cardex Detallado</field>
        <field name="model">stock.move.line</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">inventory_cardex.report_stock_move_line_cardex_document</field>
        <field name="report_file">inventory_cardex.report_stock_move_line_cardex_document</field>
        <field name="binding_model_id" ref="stock.model_stock_move_line"/>
        <field name="binding_type">report</field>
        <field name="print_report_name">'Cardex_Valorizado_%s' % (object.product_id.name)</field>
    </record>

    <!-- Template principal para reporte estilo Cardex Valorizado -->
    <template id="report_stock_move_line_cardex_document">
        <t t-call="web.html_container">
            <t t-call="web.external_layout">
                <div class="page">
                    <!-- Título principal -->
                    <h2 style="text-align: center; margin-bottom: 5px;">DETALLE DEL INVENTARIO VALORIZADO</h2>
                    
                    <!-- Información del producto (tomamos el primer registro como referencia) -->
                    <t t-if="docs">
                        <table style="width: 100%; margin-bottom: 15px; border: none;">
                            <tr>
                                <td style="border: none; padding: 5px;">
                                    <strong>Producto:</strong> <span t-field="docs[0].product_id"/>
                                </td>
                            </tr>
                            <tr>
                                <td style="border: none; padding: 5px;">
                                    <strong>Unidad de medida:</strong> <span t-field="docs[0].product_uom_id"/>
                                </td>
                            </tr>
                        </table>
                    </t>

                    <table class="table table-sm table-bordered o_report_layout_table" style="width: 100%; border-collapse: collapse; border: 1px solid black;">
                        <thead>
                            <tr style="background-color: #7b68ab; color: white; font-weight: bold;">
                                <th style="border: 1px solid black; padding: 8px;">Fecha</th>
                                <th style="border: 1px solid black; padding: 8px;">REFERENCIA</th>
                                <th colspan="3" style="border: 1px solid black; padding: 8px; text-align: center;">COMPRA</th>
                                <th colspan="3" style="border: 1px solid black; padding: 8px; text-align: center;">VENTA</th>
                                <th colspan="3" style="border: 1px solid black; padding: 8px; text-align: center;">SALDO FINAL</th>
                            </tr>
                            <tr style="background-color: #7b68ab; color: white; font-weight: bold;">
                                <th style="border: 1px solid black; padding: 8px;"></th>
                                <th style="border: 1px solid black; padding: 8px;"></th>
                                <th style="border: 1px solid black; padding: 8px; text-align: center;">CANTIDAD</th>
                                <th style="border: 1px solid black; padding: 8px; text-align: center;">PRECIO</th>
                                <th style="border: 1px solid black; padding: 8px; text-align: center;">SUBTOTAL</th>
                                <th style="border: 1px solid black; padding: 8px; text-align: center;">CANTIDAD</th>
                                <th style="border: 1px solid black; padding: 8px; text-align: center;">PRECIO</th>
                                <th style="border: 1px solid black; padding: 8px; text-align: center;">SUBTOTAL</th>
                                <th style="border: 1px solid black; padding: 8px; text-align: center;">CANTIDAD</th>
                                <th style="border: 1px solid black; padding: 8px; text-align: center;">COSTO PROMEDIO</th>
                                <th style="border: 1px solid black; padding: 8px; text-align: center;">COSTO TOTAL</th>
                            </tr>
                        </thead>
                        <tbody>
                            <t t-set="total_purchase_qty" t-value="0.0"/>
                            <t t-set="total_purchase_subtotal" t-value="0.0"/>
                            <t t-set="total_sale_qty" t-value="0.0"/>
                            <t t-set="total_sale_subtotal" t-value="0.0"/>
                            <t t-set="balance_qty" t-value="0.0"/>
                            <t t-set="balance_total_cost" t-value="0.0"/>
                            
                            <t t-foreach="docs" t-as="o">
                                <t t-set="purchase_qty" t-value="o.purchase_product_qty or 0.0"/>
                                <t t-set="purchase_price" t-value="o.purchase_price_unit or 0.0"/>
                                <t t-set="purchase_subtotal" t-value="o.purchase_price_subtotal or 0.0"/>
                                
                                <t t-set="sale_qty" t-value="o.sale_product_uom_qty or 0.0"/>
                                <t t-set="sale_price" t-value="o.sale_price_unit or 0.0"/>
                                <t t-set="sale_subtotal" t-value="o.sale_price_subtotal or 0.0"/>
                                
                                <!-- Calcular costo promedio actual antes de la transacción -->
                                <t t-set="current_avg_cost" t-value="balance_total_cost / balance_qty if balance_qty > 0 else 0.0"/>
                                
                                <!-- Actualizar saldo: compras aumentan, ventas disminuyen -->
                                <t t-if="purchase_qty > 0">
                                    <t t-set="balance_qty" t-value="balance_qty + purchase_qty"/>
                                    <t t-set="balance_total_cost" t-value="balance_total_cost + purchase_subtotal"/>
                                </t>
                                
                                <t t-if="sale_qty > 0">
                                    <t t-set="balance_qty" t-value="balance_qty - sale_qty"/>
                                    <t t-set="balance_total_cost" t-value="balance_total_cost - (sale_qty * current_avg_cost)"/>
                                </t>
                                
                                <!-- Calcular costo promedio del saldo después de la transacción -->
                                <t t-set="balance_avg_cost" t-value="balance_total_cost / balance_qty if balance_qty > 0 else 0.0"/>
                                
                                <tr>
                                    <!-- Fecha -->
                                    <td style="border: 1px solid black; padding: 5px;">
                                        <span t-field="o.date" t-options="{'widget': 'datetime'}"/>
                                    </td>
                                    
                                    <!-- Referencia -->
                                    <td style="border: 1px solid black; padding: 5px;">
                                        <span t-esc="o.reference or ''"/>
                                    </td>
                                    
                                    <!-- COMPRA - CANTIDAD (verde) -->
                                    <td style="border: 1px solid black; padding: 5px; text-align: center; color: #00b050; font-weight: bold;">
                                        <t t-if="purchase_qty > 0">
                                            <span t-esc="int(purchase_qty)"/>
                                        </t>
                                    </td>
                                    
                                    <!-- COMPRA - PRECIO (verde) -->
                                    <td style="border: 1px solid black; padding: 5px; text-align: center; color: #00b050; font-weight: bold;">
                                        <t t-if="purchase_qty > 0">
                                            <span t-esc="'{:,.2f}'.format(purchase_price)"/>
                                        </t>
                                    </td>
                                    
                                    <!-- COMPRA - SUBTOTAL (verde) -->
                                    <td style="border: 1px solid black; padding: 5px; text-align: center; color: #00b050; font-weight: bold;">
                                        <t t-if="purchase_qty > 0">
                                            <span t-esc="'{:,.2f}'.format(purchase_subtotal)"/>
                                        </t>
                                    </td>
                                    
                                    <!-- VENTA - CANTIDAD (rojo) -->
                                    <td style="border: 1px solid black; padding: 5px; text-align: center; color: #ff0000; font-weight: bold;">
                                        <t t-if="sale_qty > 0">
                                            <span t-esc="int(sale_qty)"/>
                                        </t>
                                    </td>
                                    
                                    <!-- VENTA - PRECIO (rojo) -->
                                    <td style="border: 1px solid black; padding: 5px; text-align: center; color: #ff0000; font-weight: bold;">
                                        <t t-if="sale_qty > 0">
                                            <span t-esc="'{:,.2f}'.format(sale_price)"/>
                                        </t>
                                    </td>
                                    
                                    <!-- VENTA - SUBTOTAL (rojo) -->
                                    <td style="border: 1px solid black; padding: 5px; text-align: center; color: #ff0000; font-weight: bold;">
                                        <t t-if="sale_qty > 0">
                                            <span t-esc="'{:,.2f}'.format(sale_subtotal)"/>
                                        </t>
                                    </td>
                                    
                                    <!-- SALDO FINAL - CANTIDAD -->
                                    <td style="border: 1px solid black; padding: 5px; text-align: center;">
                                        <span t-esc="int(balance_qty)"/>
                                    </td>
                                    
                                    <!-- SALDO FINAL - COSTO PROMEDIO -->
                                    <td style="border: 1px solid black; padding: 5px; text-align: center;">
                                        <t t-if="balance_qty > 0">
                                            <span t-esc="'{:,.2f}'.format(balance_avg_cost)"/>
                                        </t>
                                    </td>
                                    
                                    <!-- SALDO FINAL - COSTO TOTAL -->
                                    <td style="border: 1px solid black; padding: 5px; text-align: center;">
                                        <t t-if="balance_qty > 0">
                                            <span t-esc="'{:,.2f}'.format(balance_total_cost)"/>
                                        </t>
                                    </td>
                                </tr>
                                
                                <!-- Acumular totales -->
                                <t t-set="total_purchase_qty" t-value="total_purchase_qty + purchase_qty"/>
                                <t t-set="total_purchase_subtotal" t-value="total_purchase_subtotal + purchase_subtotal"/>
                                <t t-set="total_sale_qty" t-value="total_sale_qty + sale_qty"/>
                                <t t-set="total_sale_subtotal" t-value="total_sale_subtotal + sale_subtotal"/>
                            </t>
                        </tbody>
                        
                        <!-- Fila de TOTALES -->
                        <tfoot>
                            <tr style="background-color: #f0f0f0; font-weight: bold;">
                                <td colspan="2" style="border: 1px solid black; padding: 5px; text-align: right;">
                                    <strong>Totales</strong>
                                </td>
                                
                                <!-- TOTALES COMPRA - CANTIDAD -->
                                <td style="border: 1px solid black; padding: 5px; text-align: center; color: #00b050;">
                                    <span t-esc="int(total_purchase_qty)"/>
                                </td>
                                
                                <!-- TOTALES COMPRA - PRECIO (vacío) -->
                                <td style="border: 1px solid black; padding: 5px;"></td>
                                
                                <!-- TOTALES COMPRA - SUBTOTAL -->
                                <td style="border: 1px solid black; padding: 5px; text-align: center; color: #00b050;">
                                    <span t-esc="'{:,.2f}'.format(total_purchase_subtotal)"/>
                                </td>
                                
                                <!-- TOTALES VENTA - CANTIDAD -->
                                <td style="border: 1px solid black; padding: 5px; text-align: center; color: #ff0000;">
                                    <span t-esc="int(total_sale_qty)"/>
                                </td>
                                
                                <!-- TOTALES VENTA - PRECIO (vacío) -->
                                <td style="border: 1px solid black; padding: 5px;"></td>
                                
                                <!-- TOTALES VENTA - SUBTOTAL -->
                                <td style="border: 1px solid black; padding: 5px; text-align: center; color: #ff0000;">
                                    <span t-esc="'{:,.2f}'.format(total_sale_subtotal)"/>
                                </td>
                                
                                <!-- TOTALES SALDO FINAL - CANTIDAD -->
                                <td style="border: 1px solid black; padding: 5px; text-align: center;">
                                    <span t-esc="int(balance_qty)"/>
                                </td>
                                
                                <!-- TOTALES SALDO FINAL - COSTO PROMEDIO (vacío) -->
                                <td style="border: 1px solid black; padding: 5px;"></td>
                                
                                <!-- TOTALES SALDO FINAL - COSTO TOTAL (vacío) -->
                                <td style="border: 1px solid black; padding: 5px;"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </t>
        </t>
    </template>
</odoo>
